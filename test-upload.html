<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç®€æ˜“ä¸Šä¼ æµ‹è¯•</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .box {
      background: white;
      padding: 30px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #667eea;
      margin-top: 0;
    }
    h2 {
      color: #2c3e50;
      font-size: 1.2em;
      margin-top: 0;
    }
    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1em;
      margin: 5px;
    }
    button:hover {
      background: #5568d3;
    }
    button.danger {
      background: #e74c3c;
    }
    button.danger:hover {
      background: #c0392b;
    }
    .file-item {
      background: #f8f9fa;
      padding: 15px;
      margin: 10px 0;
      border-radius: 5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .file-info {
      flex: 1;
    }
    .file-name {
      font-weight: bold;
      margin-bottom: 5px;
    }
    .file-date {
      font-size: 0.85em;
      color: #666;
    }
    .message {
      padding: 15px;
      border-radius: 5px;
      margin: 10px 0;
    }
    .message.success {
      background: #d4edda;
      color: #155724;
    }
    .message.error {
      background: #f8d7da;
      color: #721c24;
    }
    .message.info {
      background: #d1ecf1;
      color: #0c5460;
    }
    input[type="file"] {
      margin: 10px 0;
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 5px;
      width: 100%;
    }
    .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="box">
    <h1>ğŸ§ª ç®€æ˜“ä¸Šä¼ æµ‹è¯•</h1>
    <p>è¿™æ˜¯ä¸€ä¸ªç®€åŒ–ç‰ˆçš„æµ‹è¯•é¡µé¢ï¼Œç”¨æ¥éªŒè¯ä¸Šä¼ åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚</p>
  </div>

  <div class="box">
    <h2>æ­¥éª¤ 1: æ¸…ç©ºæ•°æ®</h2>
    <p>å…ˆæ¸…ç©ºæ—§æ•°æ®ï¼Œç¡®ä¿å¹²å‡€çš„ç¯å¢ƒ</p>
    <button class="danger" onclick="clearData()">æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
    <div id="clearMsg"></div>
  </div>

  <div class="box">
    <h2>æ­¥éª¤ 2: ä¸Šä¼ æ–‡ä»¶</h2>
    <p>é€‰æ‹©ä¸€ä¸ªå°æ–‡ä»¶ï¼ˆå›¾ç‰‡æˆ–æ–‡æ¡£ï¼Œå»ºè®® < 2MBï¼‰</p>
    <input type="file" id="fileInput">
    <button onclick="uploadFile()">ä¸Šä¼ æ–‡ä»¶</button>
    <div id="uploadMsg"></div>
  </div>

  <div class="box">
    <h2>æ­¥éª¤ 3: æŸ¥çœ‹å·²ä¸Šä¼ æ–‡ä»¶</h2>
    <p>ä¸Šä¼ æˆåŠŸåï¼Œæ–‡ä»¶ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ</p>
    <button onclick="loadFiles()">åˆ·æ–°åˆ—è¡¨</button>
    <div id="fileList"></div>
  </div>

  <div class="box">
    <h2>è°ƒè¯•ä¿¡æ¯</h2>
    <button onclick="showDebugInfo()">æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯</button>
    <div id="debugInfo"></div>
  </div>

  <script>
    // æ¸…ç©ºæ•°æ®
    function clearData() {
      const msg = document.getElementById('clearMsg');
      try {
        localStorage.clear();
        msg.innerHTML = '<div class="message success">âœ“ æ•°æ®å·²æ¸…ç©ºï¼ç°åœ¨å¯ä»¥ä¸Šä¼ æ–‡ä»¶æµ‹è¯•äº†ã€‚</div>';
      } catch (error) {
        msg.innerHTML = `<div class="message error">âŒ æ¸…ç©ºå¤±è´¥: ${error.message}</div>`;
      }
      loadFiles();
    }

    // ä¸Šä¼ æ–‡ä»¶
    function uploadFile() {
      const fileInput = document.getElementById('fileInput');
      const msg = document.getElementById('uploadMsg');

      if (!fileInput.files.length) {
        msg.innerHTML = '<div class="message error">âŒ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ–‡ä»¶</div>';
        return;
      }

      const file = fileInput.files[0];

      if (file.size > 5 * 1024 * 1024) {
        msg.innerHTML = '<div class="message error">âŒ æ–‡ä»¶å¤ªå¤§ï¼Œè¯·é€‰æ‹©å°äº 5MB çš„æ–‡ä»¶</div>';
        return;
      }

      msg.innerHTML = '<div class="message info">â³ æ­£åœ¨ä¸Šä¼ ...</div>';

      const reader = new FileReader();

      reader.onload = function(e) {
        try {
          // è·å–ç°æœ‰æ–‡ä»¶åˆ—è¡¨
          let uploadedFiles = [];
          const saved = localStorage.getItem('uploadedFiles');
          if (saved) {
            uploadedFiles = JSON.parse(saved);
          }

          // æ·»åŠ æ–°æ–‡ä»¶
          const newFile = {
            name: file.name,
            size: formatFileSize(file.size),
            date: new Date().toLocaleString('zh-CN'),
            type: file.type,
            data: e.target.result
          };

          uploadedFiles.unshift(newFile);

          // ä¿å­˜
          localStorage.setItem('uploadedFiles', JSON.stringify(uploadedFiles));

          msg.innerHTML = `
            <div class="message success">
              âœ“ ä¸Šä¼ æˆåŠŸï¼<br>
              æ–‡ä»¶å: ${file.name}<br>
              å¤§å°: ${formatFileSize(file.size)}
            </div>
          `;

          // æ¸…ç©ºè¾“å…¥
          fileInput.value = '';

          // è‡ªåŠ¨åˆ·æ–°åˆ—è¡¨
          setTimeout(() => {
            loadFiles();
          }, 500);

        } catch (error) {
          msg.innerHTML = `<div class="message error">âŒ ä¸Šä¼ å¤±è´¥: ${error.message}</div>`;
        }
      };

      reader.onerror = function() {
        msg.innerHTML = '<div class="message error">âŒ æ–‡ä»¶è¯»å–å¤±è´¥</div>';
      };

      reader.readAsDataURL(file);
    }

    // åŠ è½½æ–‡ä»¶åˆ—è¡¨
    function loadFiles() {
      const container = document.getElementById('fileList');
      
      try {
        const saved = localStorage.getItem('uploadedFiles');
        
        if (!saved) {
          container.innerHTML = '<div class="message info">æ²¡æœ‰ä¸Šä¼ çš„æ–‡ä»¶</div>';
          return;
        }

        const files = JSON.parse(saved);

        if (files.length === 0) {
          container.innerHTML = '<div class="message info">æ²¡æœ‰ä¸Šä¼ çš„æ–‡ä»¶</div>';
          return;
        }

        let html = `<div class="message success">æ‰¾åˆ° ${files.length} ä¸ªæ–‡ä»¶ï¼š</div>`;

        files.forEach((file, index) => {
          html += `
            <div class="file-item">
              <div class="file-info">
                <div class="file-name">ğŸ“„ ${file.name}</div>
                <div class="file-date">${file.date} | ${file.size}</div>
                ${file.data ? '<small style="color: green;">âœ“ æœ‰æ•°æ®</small>' : '<small style="color: red;">âœ— æ— æ•°æ®</small>'}
              </div>
              <div class="btn-group">
                <button onclick="downloadFile(${index})">ä¸‹è½½</button>
                <button class="danger" onclick="deleteFile(${index})">åˆ é™¤</button>
              </div>
            </div>
          `;
        });

        container.innerHTML = html;

      } catch (error) {
        container.innerHTML = `<div class="message error">âŒ åŠ è½½å¤±è´¥: ${error.message}</div>`;
      }
    }

    // ä¸‹è½½æ–‡ä»¶
    function downloadFile(index) {
      try {
        const saved = localStorage.getItem('uploadedFiles');
        const files = JSON.parse(saved);
        const file = files[index];

        if (!file.data) {
          alert('æ–‡ä»¶æ•°æ®ä¸å­˜åœ¨');
          return;
        }

        const link = document.createElement('a');
        link.href = file.data;
        link.download = file.name;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        alert('ä¸‹è½½å·²å¼€å§‹ï¼š' + file.name);

      } catch (error) {
        alert('ä¸‹è½½å¤±è´¥ï¼š' + error.message);
      }
    }

    // åˆ é™¤æ–‡ä»¶
    function deleteFile(index) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡ä»¶å—ï¼Ÿ')) {
        return;
      }

      try {
        const saved = localStorage.getItem('uploadedFiles');
        const files = JSON.parse(saved);
        files.splice(index, 1);
        localStorage.setItem('uploadedFiles', JSON.stringify(files));
        loadFiles();
        alert('æ–‡ä»¶å·²åˆ é™¤');
      } catch (error) {
        alert('åˆ é™¤å¤±è´¥ï¼š' + error.message);
      }
    }

    // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
    function showDebugInfo() {
      const container = document.getElementById('debugInfo');
      
      try {
        const saved = localStorage.getItem('uploadedFiles');
        
        let info = '<div style="background: #2c3e50; color: #ecf0f1; padding: 15px; border-radius: 5px; margin-top: 10px; font-family: monospace; font-size: 0.85em; overflow-x: auto;">';
        
        if (!saved) {
          info += 'localStorage["uploadedFiles"] = null (æ²¡æœ‰æ•°æ®)';
        } else {
          const files = JSON.parse(saved);
          info += `æ–‡ä»¶æ•°é‡: ${files.length}<br><br>`;
          
          files.forEach((file, i) => {
            info += `æ–‡ä»¶ ${i + 1}:<br>`;
            info += `  åç§°: ${file.name}<br>`;
            info += `  å¤§å°: ${file.size}<br>`;
            info += `  æ—¥æœŸ: ${file.date}<br>`;
            info += `  ç±»å‹: ${file.type || 'æœªçŸ¥'}<br>`;
            info += `  æ•°æ®: ${file.data ? 'æœ‰ (' + (file.data.length / 1024).toFixed(2) + ' KB)' : 'æ— '}<br><br>`;
          });
        }
        
        info += '</div>';
        container.innerHTML = info;
        
      } catch (error) {
        container.innerHTML = `<div class="message error">âŒ ${error.message}</div>`;
      }
    }

    // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½æ–‡ä»¶åˆ—è¡¨
    window.onload = function() {
      loadFiles();
    };
  </script>
</body>
</html>

