<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åå°ç®¡ç† - Hakimi çš„çŒ«çˆ¬æ¶</title>
    <link rel="stylesheet" href="../css/chinese-style.css">
    <style>
        body {
            background: #f0f2f5;
            font-family: 'Segoe UI', sans-serif;
        }

        .admin-container {
            max-width: 1000px;
            margin: 50px auto;
            padding: 20px;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: white;
        }

        .btn-primary {
            background: #1890ff;
        }

        .btn-danger {
            background: #ff4d4f;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background: white;
            width: 400px;
            margin: 100px auto;
            padding: 20px;
            border-radius: 8px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>

<body>

    <div id="loginSection" class="admin-container" style="max-width: 400px; margin-top: 100px;">
        <div class="card">
            <h2 style="text-align:center; margin-bottom:20px;">ğŸ›¡ï¸ ç®¡ç†å‘˜ç™»å½•</h2>
            <div class="form-group">
                <label>è´¦å·</label>
                <input type="text" id="adminUsername" placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜è´¦å·">
            </div>
            <div class="form-group">
                <label>å¯†ç </label>
                <input type="password" id="adminPassword" placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ">
            </div>
            <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="adminLogin()">ç™»å½•</button>
        </div>
    </div>

    <div id="dashboardSection" class="admin-container" style="display: none;">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>ğŸ‘¥ ç”¨æˆ·ç®¡ç†</h2>
                <div>
                    <span style="margin-right:10px; font-weight:bold;">ç®¡ç†å‘˜</span>
                    <button class="btn btn-primary" onclick="showAddUserModal()">+ æ·»åŠ ç”¨æˆ·</button>
                    <button class="btn btn-danger" onclick="logout()">é€€å‡º</button>
                </div>
            </div>
        </div>

        <div class="card">
            <table class="table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>ç”¨æˆ·å</th>
                        <th>è§’è‰²</th>
                        <th>é‚®ç®±</th>
                        <th>æ‰‹æœº</th>
                        <th>æ³¨å†Œæ—¶é—´</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="userTableBody">
                    <!-- Users will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <h3>æ·»åŠ ç”¨æˆ·</h3>
            <div class="form-group">
                <label>ç”¨æˆ·å</label>
                <input type="text" id="newUsername">
            </div>
            <div class="form-group">
                <label>å¯†ç </label>
                <input type="text" id="newPassword">
            </div>
            <div class="form-group">
                <label>è§’è‰²</label>
                <select id="newRole">
                    <option value="user">User</option>
                    <option value="admin">Admin</option>
                </select>
            </div>
            <div style="text-align:right; margin-top:20px;">
                <button class="btn" style="background:#ccc; color:#333;" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="addUser()">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { API_BASE_URL } from '../js/api-config.js';

        // Check if already logged in
        const adminToken = localStorage.getItem('adminToken');
        if (adminToken) {
            showDashboard();
        }

        window.adminLogin = async () => {
            const username = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;

            if (!username || !password) return alert('è¯·è¾“å…¥è´¦å·å’Œå¯†ç ');

            try {
                const res = await fetch(`${API_BASE_URL}/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await res.json();

                if (res.ok) {
                    localStorage.setItem('adminToken', data.token);
                    showDashboard();
                } else {
                    alert(data.message || 'ç™»å½•å¤±è´¥');
                }
            } catch (e) {
                console.error(e);
                alert('ç½‘ç»œé”™è¯¯');
            }
        };

        function showDashboard() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('dashboardSection').style.display = 'block';
            loadUsers();
        }

        window.logout = () => {
            localStorage.removeItem('adminToken');
            window.location.reload();
        };

        // Load users
        async function loadUsers() {
            const token = localStorage.getItem('adminToken');
            try {
                const res = await fetch(`${API_BASE_URL}/admin/users`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (res.status === 403 || res.status === 401) {
                    alert('ç™»å½•è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                    logout();
                    return;
                }

                const users = await res.json();
                const tbody = document.getElementById('userTableBody');
                tbody.innerHTML = '';

                users.forEach(u => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                    <td>${u.id}</td>
                    <td>${u.username}</td>
                    <td><span style="background:${u.role === 'admin' ? '#ff4d4f' : '#1890ff'}; color:white; padding:2px 6px; border-radius:4px; font-size:12px;">${u.role}</span></td>
                    <td>${u.email || '-'}</td>
                    <td>${u.phone || '-'}</td>
                    <td>${new Date(u.created_at).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-danger" style="padding:4px 8px; font-size:12px;" onclick="deleteUser(${u.id})">åˆ é™¤</button>
                    </td>
                `;
                    tbody.appendChild(tr);
                });
            } catch (e) {
                console.error('Load users error:', e);
                alert('åŠ è½½å¤±è´¥');
            }
        }

        window.showAddUserModal = () => {
            document.getElementById('addUserModal').style.display = 'block';
        };

        window.closeModal = () => {
            document.getElementById('addUserModal').style.display = 'none';
        };

        window.addUser = async () => {
            const username = document.getElementById('newUsername').value;
            const password = document.getElementById('newPassword').value;
            const role = document.getElementById('newRole').value;
            const token = localStorage.getItem('adminToken');

            if (!username || !password) return alert('è¯·å¡«å†™ç”¨æˆ·åå’Œå¯†ç ');

            try {
                const res = await fetch(`${API_BASE_URL}/admin/users`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ username, password, role })
                });

                const data = await res.json();
                if (res.ok) {
                    alert('æ·»åŠ æˆåŠŸ');
                    closeModal();
                    loadUsers();
                } else {
                    alert(data.message || 'æ·»åŠ å¤±è´¥');
                }
            } catch (e) {
                console.error(e);
                alert('ç½‘ç»œé”™è¯¯');
            }
        };

        window.deleteUser = async (id) => {
            if (!confirm('ç¡®å®šåˆ é™¤è¯¥ç”¨æˆ·å—ï¼Ÿ')) return;
            const token = localStorage.getItem('adminToken');
            try {
                const res = await fetch(`${API_BASE_URL}/admin/users/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    alert('åˆ é™¤æˆåŠŸ');
                    loadUsers();
                } else {
                    alert('åˆ é™¤å¤±è´¥');
                }
            } catch (e) {
                console.error(e);
                alert('ç½‘ç»œé”™è¯¯');
            }
        };

        // Init
        // loadUsers(); // Don't load users immediately, wait for login
    </script>
</body>

</html>